<%= form_with(model: persson, class: "p-4 bg-light rounded shadow-sm") do |form| %>
  <% if persson.errors.any? %>
    <div class="alert alert-danger">
      <h2><%= pluralize(persson.errors.count, "error") %> prohibited this persson from being saved:</h2>
      <ul>
        <% persson.errors.each do |error| %>
          <li><%= error.full_message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

<div class="mb-3 position-relative">
  <%= form.label :phone, "Phone Number", class: "form-label" %>
  <div class="input-group">
    <%= form.text_field :phone, class: "form-control", id: "phone_field" %>
    <button type="button" class="btn btn-outline-secondary input-group-text" id="copy_phone_button" data-copy-target="#phone_field">
      <i class="bi bi-clipboard"></i>
    </button>
  </div>
</div>

<script>

  document.addEventListener('DOMContentLoaded', () => {
    const copyButtons = document.querySelectorAll('[data-copy-target]');

    copyButtons.forEach(button => {
      button.addEventListener('click', () => {
        const targetSelector = button.getAttribute('data-copy-target');
        const targetField = document.querySelector(targetSelector);

        if (targetField) {
          targetField.select();
          document.execCommand('copy');

          // Optionally, show a success message or change button text
          button.innerHTML = '<i class="bi bi-check-circle"></i>';
          setTimeout(() => {
            button.innerHTML = '<i class="bi bi-clipboard"></i>';
          }, 1500);
        }
      });
    });
  });


</script>

  <div class="mb-3">
    <%= form.label :first_name, "First Name", class: "form-label" %>
    <%= form.text_field :first_name, class: "form-control" %>
  </div>

  <div class="mb-3">
    <%= form.label :last_name, "Last Name", class: "form-label" %>
    <%= form.text_field :last_name, class: "form-control" %>
  </div>

  <div class="mb-3">
    <%= form.label :father_name, "Father's Name", class: "form-label" %>
    <%= form.text_field :father_name, class: "form-control" %>
  </div>

  <div class="mb-3">
    <%= form.label :send_address, "Shipping Address", class: "form-label" %>
    <%= form.text_field :send_address, class: "form-control" %>
  </div>

  <button type="button" id="hide_block_form_button" class="btn btn-primary mb-3">Show More</button>

  <div id="hide_section_form" class="hide-section collapsed bg-white p-3 rounded border border-light">
    <div class="mb-3">
      <%= form.label :name_for_contract, "Name for Contract", class: "form-label" %>
      <%= form.text_field :name_for_contract, class: "form-control" %>
    </div>

    <div class="mb-3">
      <%= form.label :email, "Email", class: "form-label" %>
      <%= form.text_field :email, class: "form-control" %>
    </div>

    <div class="mb-3">
      <%= form.label :role, "Role", class: "form-label" %>
      <%= form.text_field :role, class: "form-control" %>
    </div>

    <div class="mb-3">
      <%= form.label :birth_data, "Birth Date", class: "form-label" %>
      <%= form.date_field :birth_data, class: "form-control" %>
    </div>

    <div class="mb-3">
      <%= form.label :note_data, "Note Data", class: "form-label" %>
      <%= form.text_field :note_data, class: "form-control" %>
    </div>

    <div class="mb-3">
      <%= form.label :other_data, "Other Data", class: "form-label" %>
      <%= form.text_field :other_data, class: "form-control" %>
    </div>

    <div class="mb-3">
      <%= form.number_field :user_id, id: :person_user_id, class: "form-control", value: current_user.id, type: :hidden %>
    </div>
  </div>

  <div class="mb-3">
    <%= form.label :organization_id, "Organization", class: "form-label", id: "organization_label" %>
    <!-- Поле для фільтрації -->
    <input type="text" id="organization_filter" placeholder="Filter organizations..." class="form-control mb-2">
    
    <!-- Дропдаун із фільтрованими значеннями -->
    <%= select_tag 'persson[organization_id]', options_for_select(Organization.all.map { |org| [org.name, org.id, { "data-ederpou" => org.ederpou }] }), prompt: "Select an organization", class: "form-control", id: "organization_select" %>
  </div>


  <div class="mt-3">
    <%= form.submit "Submit", class: "btn btn-success" %>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const toggleButton = document.getElementById('hide_block_form_button');
      const addressSection = document.getElementById('hide_section_form');

      toggleButton.addEventListener('click', () => {
        if (addressSection.classList.contains('collapsed')) {
          addressSection.classList.remove('collapsed');
          toggleButton.textContent = 'Show Less';
        } else {
          addressSection.classList.add('collapsed');
          toggleButton.textContent = 'Show More';
        }
      });
    });
  </script>
  
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const filterInput = document.getElementById('organization_filter');
    const selectElement = document.getElementById('organization_select');
    const labelElement = document.getElementById('organization_label');

    // Зберігаємо початкові опції для скидання фільтру
    const originalOptions = Array.from(selectElement.options);

    filterInput.addEventListener('input', () => {
      const filterValue = filterInput.value.toLowerCase();

      // Очищаємо поточні опції
      selectElement.innerHTML = '';

      // Перевіряємо, чи введення починається з цифри
      const isNumeric = /^\d/.test(filterValue);

      // Фільтруємо опції
      const filteredOptions = originalOptions.filter(option => {
        if (option.value === "") return true; // залишаємо порожню опцію (prompt)
        if (isNumeric) {
          // Фільтруємо по ederpou (перевіряємо частковий збіг)
          return option.dataset.ederpou && option.dataset.ederpou.toLowerCase().includes(filterValue);
        } else {
          // Фільтруємо по name
          return option.text.toLowerCase().includes(filterValue);
        }
      });

      // Додаємо відфільтровані опції до select
      filteredOptions.forEach(option => selectElement.add(option));

      // Змінюємо текст label в залежності від типу фільтрації
      labelElement.textContent = isNumeric ? "Organization (filtered by EDRPOU)" : "Organization (filtered by Name)";
    });
  });
</script>


  <% end %>
